{
  "db_name": "PostgreSQL",
  "query": "-- Counts transactions in buckets by counting the cumulative total number of\n-- transactions at or before (i.e. <=) the start of the bucket and the same number just\n-- before (i.e. <) the next bucket. The difference between the two numbers should\n-- give the total number of transactions within the bucket.\nSELECT\n    -- The bucket time is the starting time of the bucket.\n    bucket_time,\n    -- Number of transactions at or before the bucket.\n    COALESCE(before_bucket.cumulative_num_txs, 0) as start_cumulative_num_txs,\n    -- Number of transactions at the end of the bucket.\n    COALESCE(after_bucket.cumulative_num_txs, 0) as end_cumulative_num_txs\nFROM\n    -- We generate a time series of all the buckets where transactions will be counted.\n    -- $1 is the full period, $2 is the bucket interval.\n    -- For the rest of the comments, let's go with the example of a full period of 7 days with 6 hour buckets.\n    generate_series(\n        -- The first bucket starts 7 days ago.\n        now() - $1::interval,\n        -- The final bucket starts 6 hours ago, since the bucket time is the start of the bucket.\n        now() - $2::interval,\n        -- Each bucket is seperated by 6 hours.\n        $2::interval\n    ) AS bucket_time\nLEFT JOIN LATERAL (\n    -- Selects the cumulative number of transactions at or before the start of the bucket.\n    SELECT cumulative_num_txs\n    FROM blocks\n    WHERE slot_time <= bucket_time\n    ORDER BY slot_time DESC\n    LIMIT 1\n) before_bucket ON true\nLEFT JOIN LATERAL (\n    -- Selects the cumulative number of transactions at the end of the bucket.\n    SELECT cumulative_num_txs\n    FROM blocks\n    WHERE slot_time < bucket_time + $2::interval\n    ORDER BY slot_time DESC\n    LIMIT 1\n) after_bucket ON true\n",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "bucket_time",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 1,
        "name": "start_cumulative_num_txs",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "end_cumulative_num_txs",
        "type_info": "Int8"
      }
    ],
    "parameters": {
      "Left": [
        "Interval",
        "Interval"
      ]
    },
    "nullable": [
      null,
      null,
      null
    ]
  },
  "hash": "0732306963687e503ae7caf881e9141c243cc0df5f4ae16a3af8f49fe65e4a1b"
}
