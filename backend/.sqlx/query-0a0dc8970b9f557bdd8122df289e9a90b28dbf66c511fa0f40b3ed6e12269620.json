{
  "db_name": "PostgreSQL",
  "query": "-- Inputs:\n-- $1::interval - e.g. '30 days'\n-- $2::interval - e.g. '1 days'\n-- $3::BIGINT   - mandatory token filter (token_index)\n\nWITH buckets AS (\n  SELECT bucket_start\n  FROM date_bin_series(\n    $2::interval,\n    now() - $1::interval,\n    now()\n  ) AS bucket_start\n),\n\nlatest_per_bucket AS (\n  SELECT\n    b.bucket_start AS bucket_interval_start,\n    tm.token_index,\n    tm.event_timestamp,\n    tm.cumulative_transfer_count,\n    tm.cumulative_transfer_amount\n  FROM buckets b\n  LEFT JOIN LATERAL (\n    SELECT *\n    FROM metrics_plt_transfer tm\n    WHERE tm.event_timestamp <= b.bucket_start\n      AND tm.token_index = $3::BIGINT\n    ORDER BY tm.event_timestamp DESC\n    LIMIT 1\n  ) tm ON true\n),\n\ndelta AS (\n  SELECT\n    bucket_interval_start,\n    cumulative_transfer_count,\n    cumulative_transfer_amount,\n    LAG(cumulative_transfer_count) OVER (ORDER BY bucket_interval_start) AS prev_cumulative_transfer_count,\n    LAG(cumulative_transfer_amount) OVER (ORDER BY bucket_interval_start) AS prev_cumulative_transfer_amount\n  FROM latest_per_bucket\n)\n\nSELECT\n  bucket_interval_start AS \"bucket_time!\",\n  COALESCE(cumulative_transfer_count - COALESCE(prev_cumulative_transfer_count, 0), 0) AS transfer_count,\n  COALESCE(cumulative_transfer_amount - COALESCE(prev_cumulative_transfer_amount, 0), 0) AS transfer_volume\nFROM delta\nWHERE prev_cumulative_transfer_count IS NOT NULL\nORDER BY bucket_interval_start;\n",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "bucket_time!",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 1,
        "name": "transfer_count",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "transfer_volume",
        "type_info": "Numeric"
      }
    ],
    "parameters": {
      "Left": [
        "Interval",
        "Interval",
        "Int8"
      ]
    },
    "nullable": [
      null,
      null,
      null
    ]
  },
  "hash": "0a0dc8970b9f557bdd8122df289e9a90b28dbf66c511fa0f40b3ed6e12269620"
}
