{
  "db_name": "PostgreSQL",
  "query": "-- Inputs:\n-- $1::interval - e.g. '30 days'\n-- $2::interval - e.g. '1 days'\n-- $3::BIGINT   - mandatory token filter (token_index)\n\nWITH buckets AS (\n  SELECT bucket_start\n  FROM date_bin_series(\n    $2::interval,\n    now() - $1::interval,\n    now()\n  ) AS bucket_start\n),\n\nlatest_per_bucket AS (\n  SELECT\n    b.bucket_start AS bucket_interval_start,\n    tm.token_index,\n    tm.event_timestamp,\n    tm.cumulative_transfer_count,\n    tm.cumulative_transfer_amount\n  FROM buckets b\n  LEFT JOIN LATERAL (\n    SELECT *\n    FROM metrics_specific_plt_transfer tm\n    WHERE tm.event_timestamp <= b.bucket_start\n      AND tm.token_index = $3::BIGINT\n    ORDER BY tm.event_timestamp DESC\n    LIMIT 1\n  ) tm ON true\n),\n\ndelta AS (\n  SELECT\n    bucket_interval_start,\n    token_index,\n    cumulative_transfer_count,\n    cumulative_transfer_amount,\n    LAG(cumulative_transfer_count) OVER (PARTITION BY token_index ORDER BY bucket_interval_start) AS prev_cumulative_transfer_count,\n    LAG(cumulative_transfer_amount) OVER (PARTITION BY token_index ORDER BY bucket_interval_start) AS prev_cumulative_transfer_amount\n  FROM latest_per_bucket\n)\n\nSELECT\n  bucket_interval_start AS \"bucket_time!\",\n  COALESCE(token_index, $3::BIGINT) AS \"token_index!\",\n  COALESCE(cumulative_transfer_count - COALESCE(prev_cumulative_transfer_count, 0), 0) AS transfer_count,\n  COALESCE(cumulative_transfer_amount - COALESCE(prev_cumulative_transfer_amount, 0), 0) AS transfer_volume\nFROM delta\nORDER BY bucket_interval_start;\n",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "bucket_time!",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 1,
        "name": "token_index!",
        "type_info": "Int8"
      },
      {
        "ordinal": 2,
        "name": "transfer_count",
        "type_info": "Int8"
      },
      {
        "ordinal": 3,
        "name": "transfer_volume",
        "type_info": "Numeric"
      }
    ],
    "parameters": {
      "Left": [
        "Interval",
        "Interval",
        "Int8"
      ]
    },
    "nullable": [
      null,
      null,
      null,
      null
    ]
  },
  "hash": "c70e238039adacc5446ceafe992ac52965f9ac3598ae2741222a5aa340f824ea"
}
