<template>
	<div>
		<DrawerTitle v-if="props.transaction" class="font-mono">
			<div v-if="$route.name != 'transactions-transactionHash'" class="inline">
				<LinkButton
					class="numerical"
					@click="
						drawer.push(
							'transaction',
							props.transaction?.transactionHash,
							props.transaction.id
						)
					"
				>
					{{ shortenHash(props.transaction?.transactionHash) }}
				</LinkButton>
			</div>
			<div v-else class="inline">
				{{ shortenHash(props.transaction?.transactionHash) }}
			</div>

			<TextCopy
				:text="props.transaction?.transactionHash"
				label="Click to copy transaction hash to clipboard"
				class="h-5 inline align-baseline mr-3"
				tooltip-class="font-sans"
			/>

			<Badge
				:type="
					props.transaction?.result.__typename === 'Success'
						? 'success'
						: 'failure'
				"
			>
				{{
					props.transaction?.result.__typename === 'Success'
						? 'Success'
						: 'Rejected'
				}}
			</Badge>
		</DrawerTitle>
		<DrawerContent v-if="props.transaction">
			<div class="grid gap-6 grid-cols-2 mb-16">
				<DetailsCard>
					<template #title>Block height / block hash</template>
					<template #default>
						{{ props.transaction?.block.blockHeight }}
					</template>
					<template #secondary>
						<LinkButton
							class="numerical"
							@click="
								drawer.push(
									'block',
									props.transaction?.block.blockHash,
									props.transaction?.block.id
								)
							"
						>
							<Tooltip
								:text="props.transaction?.block.blockHash"
								text-class="text-theme-body"
							>
								{{ shortenHash(props.transaction?.block.blockHash) }}
							</Tooltip>
						</LinkButton>
					</template>
				</DetailsCard>
				<DetailsCard v-if="props.transaction?.block.blockSlotTime">
					<template #title>Timestamp</template>
					<template #default>
						{{
							convertTimestampToRelative(props.transaction?.block.blockSlotTime)
						}}
					</template>
					<template #secondary>
						{{ props.transaction?.block.blockSlotTime }}
					</template>
				</DetailsCard>
				<DetailsCard v-if="props.transaction?.transactionType">
					<template #title>Transaction type / cost (Ï¾)</template>
					<template #default>
						{{ translateTransactionType(props.transaction?.transactionType) }}
					</template>
					<template #secondary>
						{{ convertMicroCcdToCcd(props.transaction?.ccdCost) }}
					</template>
				</DetailsCard>
				<DetailsCard v-if="props.transaction?.senderAccountAddress">
					<template #title>Sender</template>
					<template #default>
						<UserIcon class="h-5 inline align-baseline mr-3" />
						{{ shortenHash(props.transaction?.senderAccountAddress) }}
					</template>
				</DetailsCard>
			</div>
			<Accordion
				v-if="
					props.transaction?.result.__typename === 'Success' &&
					props.transaction.result.events
				"
			>
				Events
				<span class="text-theme-faded ml-1">
					({{ props.transaction?.result.events?.totalCount }})
				</span>
				<template #content>
					<TransactionEventList
						:events="props.transaction.result.events"
						:total-count="props.transaction?.result.events?.totalCount"
						:page-info="props.transaction.result.events?.pageInfo"
						:go-to-page="props.goToPage"
					/>
				</template>
			</Accordion>
			<Accordion v-if="props.transaction?.result.__typename === 'Rejected'">
				Reject reason
				<template #content>
					<RejectionReason :reason="props.transaction.result.reason" />
				</template>
			</Accordion>
		</DrawerContent>
	</div>
</template>

<script lang="ts" setup>
import { UserIcon } from '@heroicons/vue/solid/index.js'
import DrawerTitle from '~/components/Drawer/DrawerTitle.vue'
import DrawerContent from '~/components/Drawer/DrawerContent.vue'
import DetailsCard from '~/components/DetailsCard.vue'
import Badge from '~/components/Badge.vue'
import TextCopy from '~/components/atoms/TextCopy.vue'
import Accordion from '~/components/Accordion.vue'
import TransactionEventList from '~/components/TransactionEventList/TransactionEventList.vue'
import RejectionReason from '~/components/RejectionReason/RejectionReason.vue'
import {
	convertMicroCcdToCcd,
	convertTimestampToRelative,
	shortenHash,
} from '~/utils/format'
import { translateTransactionType } from '~/utils/translateTransactionTypes'
import type { Transaction } from '~/types/transactions'
import { useDrawer } from '~/composables/useDrawer'
import type { PageInfo } from '~/types/generated'
import type { PaginationTarget } from '~/composables/usePagination'

const selectedTxId = useTransactionDetails()
const drawer = useDrawer()

type Props = {
	transaction: Transaction
	goToPage: (page: PageInfo) => (target: PaginationTarget) => void
}

const props = defineProps<Props>()
const route = useRoute()
// Since this is used in both the drawer and other places, this is a quick way to make sure the drawer closes on route change.
watch(route, _to => {
	selectedTxId.value = ''
})
</script>

<style module>
.statusIcon {
	@apply h-4 mr-2 text-theme-interactive;
}
.cellIcon {
	@apply h-4 text-theme-white inline align-baseline;
}

.numerical {
	@apply font-mono;
	font-variant-ligatures: none;
}
</style>
